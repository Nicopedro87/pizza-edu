<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PIZZA EDU - Pedidos</title>
<style>
:root{--accent:#111;--muted:#6b7280;--line:#e5e7eb;--bg:#fff}
*{box-sizing:border-box}html,body{margin:0;padding:0;background:#fff;color:#0f172a;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,'Noto Sans',sans-serif}
img{max-width:100%;display:block}.container{max-width:960px;margin:0 auto;padding:16px}
header.hero{border:1px solid var(--line);border-radius:16px;overflow:hidden}
header.hero img{width:100%;height:260px;object-fit:cover}.branding{padding:16px;display:flex;flex-direction:column;gap:6px}
.branding h1{margin:0;font-size:clamp(28px,4.5vw,42px);letter-spacing:.5px;color:var(--accent)}.branding p{margin:0;color:var(--muted);font-weight:500}

details{border:1px solid var(--line);border-radius:14px;background:#fff;margin:14px 0;overflow:hidden}
details[open]{box-shadow:0 2px 16px rgba(2,6,23,.06)}summary{list-style:none;cursor:pointer;padding:14px 16px;font-weight:700;font-size:18px;display:flex;align-items:center;justify-content:space-between}
summary::-webkit-details-marker{display:none}.chev{transition:transform .2s ease}details[open] .chev{transform:rotate(180deg)}
.section-body{padding:4px 14px 14px;border-top:1px dashed var(--line)}
.item-row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 6px;border-bottom:1px dashed var(--line)}
.item-row:last-child{border-bottom:0}.item-title{font-weight:600}.price{color:var(--muted);font-weight:600;min-width:82px;text-align:right}
.qty{display:flex;align-items:center;gap:6px}.btn{padding:6px 10px;border:1px solid var(--line);background:#fff;border-radius:10px;cursor:pointer;font-weight:700}
.btn:hover{background:#f8fafc}.pill{padding:8px 12px;border-radius:999px;font-weight:700;border:1px solid var(--line);background:#fff;cursor:pointer}

.builder-note{margin:10px 0 8px;color:var(--muted)}
.sabores-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:10px}
.sabor{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:12px;padding:10px}
.counter{display:flex;align-items:center;gap:8px}.counter button{width:28px;height:28px;border-radius:8px}
.cta{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}.cta .primary{background:var(--accent);color:#fff;border-color:var(--accent)}.cta .primary[disabled]{opacity:.35;cursor:not-allowed}

.customer .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
.field label{font-weight:700;font-size:14px;display:block;margin-bottom:6px}
.field input,.field textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;font:inherit}
.helper{font-size:14px;color:var(--muted)}
.pay-details{margin:4px 0 8px}

.cart{border:1px solid var(--line);border-radius:14px;margin-top:14px;padding:12px}
.cart h2{margin:0 0 8px;font-size:18px}
.cart-list{display:flex;flex-direction:column;gap:6px;max-height:220px;overflow:auto;border-top:1px dashed var(--line);padding-top:8px}
.cart-item{display:flex;justify-content:space-between;gap:12px;padding:6px 0;border-bottom:1px dashed var(--line)}
.total{display:flex;align-items:center;justify-content:space-between;font-weight:800;font-size:18px;margin-top:8px}
.payment{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:8px 0}
.pay-btn{padding:10px 14px;border-radius:12px;font-weight:800;border:0;cursor:pointer}.pay-efectivo{background:#111;color:#fff}
.badge{font-size:12px;color:#fff;background:#b45309;border-radius:999px;padding:2px 8px;margin-left:8px}.muted{color:#6b7280}

/* Wizard */
.wizard{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);padding:8px 0;margin-bottom:8px}
.steps{display:flex;gap:8px;flex-wrap:wrap}
.step{padding:6px 10px;border:1px solid var(--line);border-radius:999px;font-weight:700;color:#374151}
.step.active{background:#111;color:#fff;border-color:#111}
.step.done{background:#1110a;color:#111;border-color:#1112}
.nav-wizard{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}

/* Subtotal fijo abajo */
body{padding-bottom:60px}
.subtotal-bar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--line);padding:10px 16px;z-index:50}
.subtotal-bar .line{max-width:960px;margin:0 auto;display:flex;justify-content:flex-end;font-weight:800}
</style>
</head>
<body>
<div class="container">

  <header class="hero">
    <img src="img-pizza-edu.jpg" alt="Pizza PIZZA EDU"/>
    <div class="branding">
      <h1>PIZZA EDU</h1>
      <p><strong>Horarios:</strong> Jueves a domingo y feriados de 19 a 23 hs.</p>
    </div>
  </header>

  <!-- WIZARD: ahora 3 pasos -->
  <div class="wizard">
    <div class="steps">
      <div class="step" data-stepbtn="1">1) Pedido</div>
      <div class="step" data-stepbtn="2">2) Datos</div>
      <div class="step" data-stepbtn="3">3) Pago</div>
    </div>
    <div class="nav-wizard">
      <button class="btn" id="prevBtn">← Anterior</button>
      <button class="btn" id="nextBtn">Siguiente →</button>
    </div>
  </div>

  <!-- STEP 1: ELECCIÓN DEL PEDIDO -->
  <section data-step="1">
    <details open>
      <summary>PROMOCIONES <span class="chev">▾</span></summary>
      <div class="section-body">
        <div class="item-row" data-id="promo-3-muzza">
          <div class="item-title">3 muzza</div>
          <div class="price" data-price>--</div>
          <div class="qty"><button class="btn minus">−</button><strong class="q">0</strong><button class="btn plus">+</button></div>
        </div>
        <div class="item-row" data-id="promo-1-muzza-1-especial">
          <div class="item-title">1 muzza - 1 especial</div>
          <div class="price" data-price>--</div>
          <div class="qty"><button class="btn minus">−</button><strong class="q">0</strong><button class="btn plus">+</button></div>
        </div>
        <div class="item-row" data-id="promo-1-muzza-6-emp">
          <div class="item-title">1 muzza - 6 empanadas</div>
          <div class="price" data-price>--</div>
          <div class="qty"><button class="btn minus">−</button><strong class="q">0</strong><button class="btn plus">+</button></div>
        </div>
        <div class="item-row" data-id="promo-1-especial-6-emp">
          <div class="item-title">1 especial - 6 empanadas</div>
          <div class="price" data-price>--</div>
          <div class="qty"><button class="btn minus">−</button><strong class="q">0</strong><button class="btn plus">+</button></div>
        </div>
      </div>
    </details>

    <details>
      <summary>PIZZAS <span class="chev">▾</span></summary>
      <div class="section-body">
        <div class="item-row" data-id="pizza-muzza"><div class="item-title">Muzza</div><div class="price" data-price>--</div><div class="qty"><button class="btn minus">−</button><strong class="q">0</strong><button class="btn plus">+</button></div></div>
        <div class="item-row" data-id="pizza-jamon"><div class="item-title">Jamón</div><div class="price" data-price>--</div><div class="qty"><button class="btn minus">−</button><strong class="q">0</strong><button class="btn plus">+</button></div></div>
        <div class="item-row" data-id="pizza-jamon-morron"><div class="item-title">Jamón y morrón</div><div class="price" data-price>--</div><div class="qty"><button class="btn minus">−</button><strong class="q">0</strong><button class="btn plus">+</button></div></div>
        <div class="item-row" data-id="pizza-calabresa"><div class="item-title">Calabresa</div><div class="price" data-price>--</div><div class="qty"><button class="btn minus">−</button><strong class="q">0</strong><button class="btn plus">+</button></div></div>
        <div class="item-row" data-id="pizza-panceta"><div class="item-title">Panceta</div><div class="price" data-price>--</div><div class="qty"><button class="btn minus">−</button><strong class="q">0</strong><button class="btn plus">+</button></div></div>
        <div class="item-row" data-id="pizza-panceta-cebolla-caram"><div class="item-title">Panceta y cebolla caram.</div><div class="price" data-price>--</div><div class="qty"><button class="btn minus">−</button><strong class="q">0</strong><button class="btn plus">+</button></div></div>
        <div class="item-row" data-id="pizza-napolitana"><div class="item-title">Napolitana</div><div class="price" data-price>--</div><div class="qty"><button class="btn minus">−</button><strong class="q">0</strong><button class="btn plus">+</button></div></div>
        <div class="item-row" data-id="pizza-napolitana-jamon"><div class="item-title">Napolitana con jamón</div><div class="price" data-price>--</div><div class="qty"><button class="btn minus">−</button><strong class="q">0</strong><button class="btn plus">+</button></div></div>
        <div class="item-row" data-id="pizza-huevo"><div class="item-title">Huevo</div><div class="price" data-price>--</div><div class="qty"><button class="btn minus">−</button><strong class="q">0</strong><button class="btn plus">+</button></div></div>
        <div class="item-row" data-id="pizza-fugazzetta"><div class="item-title">Fugazzetta</div><div class="price" data-price>--</div><div class="qty"><button class="btn minus">−</button><strong class="q">0</strong><button class="btn plus">+</button></div></div>
        <div class="item-row" data-id="pizza-roquefort"><div class="item-title">Roquefort</div><div class="price" data-price>--</div><div class="qty"><button class="btn minus">−</button><strong class="q">0</strong><button class="btn plus">+</button></div></div>
      </div>
    </details>

    <details>
      <summary>EMPANADAS Y CANASTITAS <span class="chev">▾</span></summary>
      <div class="section-body" id="empanadas">
        <div class="item-row" data-id="emp-unidad">
          <div>
            <div class="item-title">Por unidad</div>
            <div class="muted">Elegí sabores. Cantidad libre.</div>
          </div>
          <div class="price" id="price-emp-unidad">$ 0</div>
          <button class="pill" onclick="openBuilder('unidad')">Seleccionar</button>
        </div>
        <div class="item-row" data-id="emp-media">
          <div>
            <div class="item-title">Media docena</div>
            <div class="muted">Elegí 6 sabores por cada media docena.</div>
          </div>
          <div class="price" id="price-emp-media">$ 0</div>
          <button class="pill" onclick="openBuilder('media')">Seleccionar</button>
        </div>
        <div class="item-row" data-id="emp-docena">
          <div>
            <div class="item-title">Docena</div>
            <div class="muted">Elegí 12 sabores por cada docena.</div>
          </div>
          <div class="price" id="price-emp-docena">$ 0</div>
          <button class="pill" onclick="openBuilder('docena')">Seleccionar</button>
        </div>
      </div>
    </details>
  </section>

  <!-- STEP 2: DATOS -->
  <section data-step="2" class="hidden">
    <section class="customer">
      <h2 style="margin: 8px 0;">Datos para el pedido</h2>
      <form id="customerForm" class="form-grid" autocomplete="on">
        <div class="field">
          <label for="inpNombre">Tu nombre</label>
          <input id="inpNombre" name="name" autocomplete="name" autocapitalize="words" spellcheck="false" type="text" placeholder="Ej: Juan Pérez" required>
        </div>
        <div class="field">
          <label for="inpWhatsapp">Número de WhatsApp</label>
          <input id="inpWhatsapp" name="tel" autocomplete="tel-national" inputmode="tel" type="tel" placeholder="Ej: 11 5555-5555" required>
        </div>
        <div class="field" style="grid-column: 1 / -1;">
          <label for="inpDireccion">Dirección</label>
          <input id="inpDireccion" name="street-address" autocomplete="street-address" autocapitalize="words" type="text" placeholder="Calle 123, piso/depto" required>
        </div>
        <div class="field" style="grid-column: 1 / -1;">
          <label for="inpAclaracion">Aclaración (opcional)</label>
          <textarea id="inpAclaracion" name="address-line2" autocomplete="address-line2" rows="2" placeholder="Ej: Enfrente del colegio Nº 14"></textarea>
        </div>
      </form>
    </section>
  </section>

  <!-- STEP 3: PAGO -->
  <section data-step="3" class="hidden">
    <h2 style="margin:0 0 8px;">Forma de pago</h2>
    <div class="payment">
      <label><input type="radio" name="pay" value="efectivo" checked> Efectivo</label>
      <label><input type="radio" name="pay" value="mp"> Mercado Pago</label>
    </div>
    <div id="payDetails" class="pay-details">
      <div id="payEfectivo">
        <div class="field" style="max-width: 320px;">
          <label for="inpPagaCon">¿Con cuánto pagás?</label>
          <input id="inpPagaCon" type="number" inputmode="decimal" placeholder="Ej: 10000">
          <small class="muted">Calculamos el vuelto en la comanda.</small>
        </div>
      </div>
      <div id="payMP" hidden class="helper">
        <div id="mpText" class="muted" style="font-weight:600;"></div>
        <small class="muted">Alias: <strong>Pedro-mp</strong></small>
      </div>
    </div>

    <div class="cart">
      <h2>Resumen</h2>
      <div id="cartList" class="cart-list"></div>
      <div class="total"><span>Total</span><span id="totalTxt">$ 0</span></div>

      <div class="actions">
        <button class="pay-btn pay-efectivo" id="finalBtn">Finalizar pedido</button>
      </div>
    </div>
  </section>

</div>

<!-- MODAL BUILDER (Empanadas/Canastitas) -->
<dialog id="builder" style="border:0;border-radius:16px;padding:0;width:min(880px,92vw)">
  <div style="padding:16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between">
    <strong id="builderTitle">Elegí tus sabores</strong>
    <button class="btn" onclick="closeBuilder()">✕</button>
  </div>
  <div style="padding:16px">
    <div class="field" style="max-width:220px;margin:0 0 8px;">
      <label for="builderQty" id="qtyLabel">Cantidad</label>
      <input id="builderQty" type="number" min="1" value="1">
    </div>
    <div id="faltan" class="builder-note"></div>
    <div class="sabores-grid" id="saboresGrid"></div>
    <div class="cta">
      <button id="agregarCombo" class="btn primary" disabled>Confirmar selección</button>
      <button class="btn" onclick="resetSabores()">Reiniciar</button>
    </div>
  </div>
</dialog>

<!-- MODAL PICKER (Especial de pizza) -->
<dialog id="pickerEspecial" style="border:0;border-radius:16px;padding:0;width:min(520px,92vw)">
  <div style="padding:16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between">
    <strong>Elegí tu pizza especial (1)</strong>
    <button class="btn" onclick="document.getElementById('pickerEspecial').close()">✕</button>
  </div>
  <div style="padding:16px">
    <div class="sabores-grid" id="espGrid"></div>
    <div class="cta">
      <button id="confirmEsp" class="btn primary" disabled>Confirmar</button>
    </div>
  </div>
</dialog>

<!-- MODAL RESUMEN/CONFIRMACIÓN -->
<dialog id="summaryDlg" style="border:0;border-radius:16px;padding:0;width:min(700px,92vw)">
  <div style="padding:16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between">
    <strong>Revisá tu pedido</strong>
    <button class="btn" onclick="document.getElementById('summaryDlg').close()">✕</button>
  </div>
  <div style="padding:16px">
    <div id="summaryBody" style="display:flex;flex-direction:column;gap:6px"></div>
    <div class="total" style="margin-top:10px;"><span>Total</span><span id="sumTotalTxt">$ 0</span></div>
    <div class="actions" style="margin-top:12px;">
      <button class="btn" onclick="document.getElementById('summaryDlg').close()">Volver</button>
      <button class="btn" id="confirmSendBtn" style="background:#111;color:#fff;border:0">Enviar por WhatsApp</button>
    </div>
  </div>
</dialog>

<!-- Subtotal fijo abajo -->
<div class="subtotal-bar">
  <div class="line">Subtotal: <span id="subtotalBarTxt" style="margin-left:6px">$ 0</span></div>
</div>

<script>
/* ===== CONFIG ===== */
const PRICES_SHEET_URL = "https://opensheet.elk.sh/13M5CpzElPosI_bTuzFyTgwCjNKd6LOVspKGWROSAhhc/precios";
const WHATSAPP_PHONE = "5491168604990"; // tu número (AR): 54 9 11 ...

/* ===== CATÁLOGO ===== */
const CATALOG = {
  promos: [
    { id: "promo-3-muzza", name: "3 muzza", price: 0 },
    { id: "promo-1-muzza-1-especial", name: "1 muzza - 1 especial", price: 0 },
    { id: "promo-1-muzza-6-emp", name: "1 muzza - 6 empanadas", price: 0 },
    { id: "promo-1-especial-6-emp", name: "1 especial - 6 empanadas", price: 0 }
  ],
  pizzas: [
    { id: "pizza-muzza", name: "Muzza", price: 0 },
    { id: "pizza-jamon", name: "Jamón", price: 0 },
    { id: "pizza-jamon-morron", name: "Jamón y morrón", price: 0 },
    { id: "pizza-calabresa", name: "Calabresa", price: 0 },
    { id: "pizza-panceta", name: "Panceta", price: 0 },
    { id: "pizza-panceta-cebolla-caram", name: "Panceta y cebolla caram.", price: 0 },
    { id: "pizza-napolitana", name: "Napolitana", price: 0 },
    { id: "pizza-napolitana-jamon", name: "Napolitana con jamón", price: 0 },
    { id: "pizza-huevo", name: "Huevo", price: 0 },
    { id: "pizza-fugazzetta", name: "Fugazzetta", price: 0 },
    { id: "pizza-roquefort", name: "Roquefort", price: 0 }
  ],
  empanadasCombos: [
    { id: "emp-unidad", name: "Por unidad", size: 1, price: 0 },
    { id: "emp-media", name: "Media docena", size: 6, price: 0 },
    { id: "emp-docena", name: "Docena", size: 12, price: 0 }
  ],
  saboresEmpanadas: ["Carne","Pollo","Jamón y queso","Pollo y roquefort","Jamón y roquefort","Panceta y ciruela"],
  saboresCanastitas: ["Choclo","Choclo y cebolla","Verdura y queso","Cebolla y roquefort","Caprese","Tomate y huevo","Cebolla y queso"],
  especiales: ["Jamón y morrón","Calabresa","Napolitana"]
};
const PROMO_RULES = {
  "promo-1-muzza-1-especial": { especial: true },
  "promo-1-especial-6-emp":   { especial: true, emp: 6 },
  "promo-1-muzza-6-emp":      { emp: 6 }
};

/* ===== ESTADO + HELPERS ===== */
const cart = [];
const qtyState = new Map();
const $ = sel=>document.querySelector(sel);
const $$ = sel=>document.querySelectorAll(sel);
const formatMoney = (n=0) => "$ " + (Number(n||0)).toLocaleString("es-AR");
const slug = s=>s.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
const CUSTOMER_KEY="pizzaedu.customer";

function saveCustomer(){
  const payload = {
    name: $('#inpNombre')?.value || "",
    tel:  $('#inpWhatsapp')?.value || "",
    addr: $('#inpDireccion')?.value || "",
    note: $('#inpAclaracion')?.value || "",
  };
  localStorage.setItem(CUSTOMER_KEY, JSON.stringify(payload));
}
function loadCustomer(){
  try{
    const d=JSON.parse(localStorage.getItem(CUSTOMER_KEY)||"{}");
    if(d.name) $('#inpNombre').value=d.name;
    if(d.tel)  $('#inpWhatsapp').value=d.tel;
    if(d.addr) $('#inpDireccion').value=d.addr;
    if(d.note) $('#inpAclaracion').value=d.note;
  }catch(_){}
}
function findById(id){
  return CATALOG.promos.find(x=>x.id===id) ||
         CATALOG.pizzas.find(x=>x.id===id) ||
         CATALOG.empanadasCombos.find(x=>x.id===id) ||
         {id, name:id, price:0};
}

/* Conecta +/− y maneja promos con selección */
function wireStaticRows() {
  document.querySelectorAll(".item-row[data-id]").forEach(row => {
    const id = row.getAttribute("data-id");
    const it = findById(id);

    const pEl = row.querySelector("[data-price]") || row.querySelector(".price");
    if (pEl) pEl.textContent = formatMoney(it.price);

    const qEl = row.querySelector(".q");
    const plus = row.querySelector(".plus");
    const minus = row.querySelector(".minus");

    let q = qtyState.get(id) || 0;
    if (qEl) qEl.textContent = q;

    plus && plus.addEventListener("click", async () => {
      if (PROMO_RULES[id]) {
        const rule = PROMO_RULES[id];
        let parts = [];
        if (rule.especial) {
          const esp = await pickEspecial(); if(!esp) return;
          parts.push(`Especial: ${esp}`);
        }
        if (rule.emp) {
          const emp = await chooseEmpanadas(rule.emp); if(!emp) return;
          parts.push(`Empanadas: ${emp}`);
        }
        upsertCart(id+":"+Date.now(), it.name, 1, it.price, parts.join(" | "));
        q = (q||0)+1; qtyState.set(id,q); if(qEl) qEl.textContent=q;
        return;
      }
      q = (q || 0) + 1; qtyState.set(id, q); if (qEl) qEl.textContent = q;
      upsertCart(id, it.name, q, it.price);
    });

    minus && minus.addEventListener("click", () => {
      q = Math.max(0, (q || 0) - 1);
      qtyState.set(id, q);
      if (qEl) qEl.textContent = q;
      upsertCart(id, it.name, q, it.price);
    });
  });
}

function upsertCart(id,name,qty,price,details=null){
  const ix = cart.findIndex(x => x.id===id && JSON.stringify(x.details||null)===JSON.stringify(details||null));
  if(ix>-1){
    if(qty<=0) cart.splice(ix,1); else cart[ix]={id,name,qty,price,details};
  }else{
    if(qty>0) cart.push({id,name,qty,price,details});
  }
  renderCart();
}
function removeItem(id,details){
  const ix = cart.findIndex(x => x.id===id && JSON.stringify(x.details||null)===JSON.stringify(details||null));
  if(ix>-1) cart.splice(ix,1);
  renderCart();
}

function refreshVisiblePrices(){
  document.querySelectorAll(".item-row[data-id]").forEach(row => {
    const id = row.getAttribute("data-id");
    const it = findById(id);
    const pEl = row.querySelector("[data-price]") || row.querySelector(".price");
    if (pEl) pEl.textContent = formatMoney(it.price);
  });
  document.querySelectorAll("[id^='price-']").forEach(el => {
    const id = el.id.replace("price-","");
    const it = findById(id);
    if (it) el.textContent = formatMoney(it.price);
  });
}

/* ===== Builder empanadas/canastitas ===== */
let activeCombo=null; let saboresSel=new Map(); let builderResolve=null; let selectOnly=false;

function openBuilder(tipoOrCfg){
  const comboIndex = {unidad:0,media:1,docena:2};
  let base, title, qtyInit=1, cfg={};

  if (typeof tipoOrCfg === 'string') {
    base = CATALOG.empanadasCombos[comboIndex[tipoOrCfg]];
    title = base.name;
    cfg = {baseSize: base.size, price: base.price, id: base.id};
  } else {
    cfg = tipoOrCfg;
    title = cfg.title;
  }

  activeCombo = { id: cfg.id||"emp-custom", name: title, baseSize: cfg.baseSize, price: cfg.price||0, qty: qtyInit, size: cfg.baseSize*qtyInit };
  saboresSel = new Map();
  selectOnly = !!cfg.selectOnly;

  $("#builderTitle").textContent = `${title} — elegí ${activeCombo.size} sabor(es)`;
  $("#faltan").textContent = `Te faltan ${activeCombo.size}`;

  const qty = $("#builderQty");
  $("#qtyLabel").textContent = `Cantidad de ${title.toLowerCase()}`;
  qty.value = 1;
  qty.oninput = () => {
    const v = Math.max(1, Number(qty.value||1));
    activeCombo.qty = v;
    activeCombo.size = activeCombo.baseSize * v;
    let total=0; saboresSel.forEach(n=>total+=n);
    const faltan = Math.max(0, activeCombo.size - total);
    $("#builderTitle").textContent = `${title} — elegí ${activeCombo.size} sabor(es)`;
    $("#faltan").innerHTML = faltan===0 ? `<span class="badge">¡Listo!</span> Ya podés confirmar` : `Te faltan <strong>${faltan}</strong>`;
    $("#agregarCombo").disabled = faltan!==0;
  };

  const grid=$("#saboresGrid"); grid.innerHTML="";
  const section = t => { const h=document.createElement("h4"); h.textContent=t; h.style.margin="6px 0"; h.style.gridColumn="1 / -1"; return h; };
  const renderGroup = list => {
    list.forEach(sabor=>{
      const row=document.createElement("div");
      row.className="sabor";
      row.innerHTML=`
        <div>${sabor}</div>
        <div class="counter">
          <button class="btn" onclick="chgSabor('${sabor.replace(/'/g,"\\'")}',-1)">−</button>
          <strong id="s-${slug(sabor)}">0</strong>
          <button class="btn" onclick="chgSabor('${sabor.replace(/'/g,"\\'")}',1)">+</button>
        </div>`;
      grid.appendChild(row);
    });
  };
  grid.appendChild(section("Empanadas"));
  renderGroup(CATALOG.saboresEmpanadas);
  grid.appendChild(section("Canastitas"));
  renderGroup(CATALOG.saboresCanastitas);

  $("#agregarCombo").onclick = () => {
  const list = [];
  saboresSel.forEach((qty, sabor) => list.push(`${sabor} x${qty}`));
  const details = list.join(" · ");

  if (selectOnly && builderResolve) {   // usado por promos
    builderResolve(details);
    closeBuilder();
    return;
  }

  // ✅ price = precio unitario del combo (unidad / media / docena)
  // ✅ qty   = cantidad de combos elegidos
  // ✅ el nombre NO lleva "xN" (ya lo muestra el carrito)
  upsertCart(
    activeCombo.id + ":" + Date.now(),
    `${activeCombo.name} (empanadas/canastitas)`,
    activeCombo.qty,
    activeCombo.price,
    details
  );

  closeBuilder();
};
function chgSabor(sabor,delta){
  const curr=(saboresSel.get(sabor)||0)+delta; if(curr<0) return;
  let total=0; saboresSel.forEach(v=>total+=v);
  const newTotal=total+delta; if(newTotal>activeCombo.size) return;
  if(curr===0) saboresSel.delete(sabor); else saboresSel.set(sabor,curr);
  $("#s-"+slug(sabor)).textContent=curr;
  const faltan=activeCombo.size-newTotal;
  $("#faltan").innerHTML = faltan===0 ? `<span class="badge">¡Listo!</span> Ya podés confirmar` : `Te faltan <strong>${faltan}</strong>`;
  $("#agregarCombo").disabled = faltan!==0;
}
function resetSabores(){ saboresSel=new Map(); $$("#saboresGrid strong[id^='s-']").forEach(el=>el.textContent="0"); $("#faltan").textContent=`Te faltan ${activeCombo.size}`; $("#agregarCombo").disabled=true; }
function closeBuilder(){ $("#builder").close(); }
function chooseEmpanadas(baseSize){
  return new Promise(resolve=>{
    builderResolve = resolve;
    openBuilder({title:`Empanadas (${baseSize})`, baseSize, price:0, id:"emp-promo", selectOnly:true});
  });
}

/* ===== Picker especial ===== */
function pickEspecial(){
  return new Promise(resolve=>{
    const dlg = $("#pickerEspecial");
    const grid = $("#espGrid"); grid.innerHTML="";
    let selected = null;
    CATALOG.especiales.forEach(opt=>{
      const row=document.createElement("div");
      row.className="sabor";
      row.innerHTML=`<div>${opt}</div><div><input type="radio" name="esp" value="${opt}"></div>`;
      grid.appendChild(row);
    });
    grid.querySelectorAll('input[name="esp"]').forEach(r=>{
      r.addEventListener('change',()=>{ selected=r.value; $("#confirmEsp").disabled=false; });
    });
    $("#confirmEsp").disabled=true;
    $("#confirmEsp").onclick=()=>{ dlg.close(); resolve(selected); };
    dlg.addEventListener('close', ()=>{ if(!selected) resolve(null); }, {once:true});
    dlg.showModal();
  });
}

/* ===== Pago ===== */
function selectedPayMethod(){ const r=document.querySelector('input[name="pay"]:checked'); return r? r.value : 'efectivo'; }
function updateMPText(){
  const span = $('#mpText'); if (!span) return;
  const total = $('#totalTxt')?.textContent || '$ 0';
  span.textContent = `¡Perfecto! Transferí el monto total de ${total} al alias "Pedro-mp" y compartime el comprobante.`;
}
function updatePayDetails(){
  const m=selectedPayMethod();
  $('#payEfectivo').hidden = m!=='efectivo';
  $('#payMP').hidden       = m!=='mp';
  updateMPText();
}

/* ===== Cart + Subtotal fijo ===== */
function renderCart(){
  const list=$("#cartList"); if(!list) return;
  list.innerHTML=cart.length?"":"<div class='muted'>Tu carrito está vacío.</div>";
  let total=0;
  cart.forEach(item=>{
    const line=document.createElement("div");
    line.className="cart-item";
    const detailsTxt=item.details?`<div class="muted" style="font-size:12px;">${item.details}</div>`:"";
    line.innerHTML=`
      <div style="flex:1 1 auto;">
        <strong>${item.name}</strong> <span class="muted">x${item.qty}</span>
        ${detailsTxt}
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <div class="muted">${formatMoney(item.price)}</div>
        <button class="btn" onclick='removeItem("${item.id}", ${JSON.stringify(item.details||null)})'>✕</button>
      </div>`;
    list.appendChild(line);
    total+=(item.price||0)*item.qty;
  });
  const t = $("#totalTxt"); if (t) t.textContent = formatMoney(total);
  $("#subtotalBarTxt").textContent = formatMoney(total); // barra fija
  updatePayDetails();
}

/* ===== Comanda PNG (sin mostrar en la página) ===== */
function buildTicketPNG(){
  const nombre = $('#inpNombre')?.value.trim() || "";
  const whatsapp = $('#inpWhatsapp')?.value.trim() || "";
  const direccion = $('#inpDireccion')?.value.trim() || "";
  const aclaracion = $('#inpAclaracion')?.value.trim() || "";
  const totalTxt = $("#totalTxt").textContent;
  const metodo = selectedPayMethod();
  const pagaConRaw = $('#inpPagaCon')?.value.trim() || "";
  const totalNum = Number(totalTxt.replace(/[^\d,.-]/g,'').replace(/\./g,'').replace(',', '.')) || 0;

  const W=800,P=32,lineH=34; const itemsLines=[];
  cart.forEach(i=>{ itemsLines.push(`${i.name} x${i.qty}`); if(i.details) itemsLines.push(`  - ${i.details}`); itemsLines.push(`  $ ${Number(i.price||0).toLocaleString('es-AR')}`); });

  const canvas=document.createElement('canvas'); const N=14+itemsLines.length;
  canvas.width=W; canvas.height=P*2+N*lineH;
  const ctx=canvas.getContext('2d'); ctx.fillStyle="#fff"; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#000"; ctx.font="bold 28px system-ui,-apple-system,Segoe UI,Roboto,Arial";
  let y=P; ctx.fillText("PIZZA EDU - COMANDA",P,y); y+=lineH;
  ctx.font="16px system-ui"; ctx.fillText(new Date().toLocaleString(),P,y); y+=lineH*1.2;
  ctx.font="bold 18px system-ui"; ctx.fillText("Cliente",P,y); y+=lineH;
  ctx.font="16px system-ui";
  ctx.fillText(`Nombre: ${nombre}`,P,y); y+=lineH;
  ctx.fillText(`WhatsApp: ${whatsapp}`,P,y); y+=lineH;
  ctx.fillText(`Dirección: ${direccion}`,P,y); y+=lineH;
  if(aclaracion){ ctx.fillText(`Aclaración: ${aclaracion}`,P,y); y+=lineH; }
  y+=8; ctx.font="bold 18px system-ui"; ctx.fillText("Pedido",P,y); y+=lineH;
  ctx.font="16px system-ui"; itemsLines.forEach(l=>{ ctx.fillText(l,P,y); y+=lineH; });
  y+=6; ctx.font="bold 18px system-ui"; ctx.fillText(`Total: ${totalTxt}`,P,y); y+=lineH;
  ctx.font="16px system-ui";
  if(metodo==='efectivo'){
    let linea="Pago en efectivo";
    if(pagaConRaw){
      const pagaCon=Number(pagaConRaw.replace(/\./g,'').replace(',', '.'));
      if(!isNaN(pagaCon)&&pagaCon>0){
        const vuelto=Math.max(0,pagaCon-totalNum);
        linea+=` — con $ ${pagaCon.toLocaleString('es-AR')}`;
        if(vuelto>0) linea+=` (vuelto $ ${vuelto.toLocaleString('es-AR')})`;
      }
    }
    ctx.fillText(linea,P,y);
  }else{
    ctx.fillText('Pago con Mercado Pago — alias "Pedro-mp"',P,y);
  }
  const dataURL=canvas.toDataURL("image/png");
  return dataURL;
}

/* ===== Envío por WhatsApp ===== */
function buildWhatsAppText(){
  const nombre = $('#inpNombre')?.value.trim() || "";
  const whatsapp = $('#inpWhatsapp')?.value.trim() || "";
  const direccion = $('#inpDireccion')?.value.trim() || "";
  const aclaracion = $('#inpAclaracion')?.value.trim() || "";
  const totalTxt = $("#totalTxt").textContent;
  const metodo = selectedPayMethod();

  let resumen = "Hola! Quiero hacer este pedido:\n\n";
  cart.forEach(i=>{
    resumen += `• ${i.name} x${i.qty}\n`;
    if(i.details) resumen += `  - ${i.details}\n`;
  });
  resumen += `\nTotal: ${totalTxt}\n\nDatos de entrega:\nNombre: ${nombre}\nWhatsApp: ${whatsapp}\nDirección: ${direccion}`;
  if(aclaracion) resumen += `\nAclaración: ${aclaracion}`;
  resumen += `\n\n${metodo==='efectivo' ? 'Pago en efectivo' : 'Pago con Mercado Pago'}`;
  return resumen;
}

async function shareTicketOrFallback(){
  const pngData = buildTicketPNG();
  try{
    const blob = await (await fetch(pngData)).blob();
    const file = new File([blob],"comanda.png",{type:"image/png"});
    if(navigator.canShare && navigator.canShare({files:[file]})){
      await navigator.share({ files:[file], title:"Comanda", text:"Comanda de pedido" });
      return;
    }
  }catch(_){}
  // Fallback: mensaje de texto
  const text = buildWhatsAppText();
  const url = WHATSAPP_PHONE
    ? `https://wa.me/${WHATSAPP_PHONE}?text=${encodeURIComponent(text)}`
    : `https://wa.me/?text=${encodeURIComponent(text)}`;
  window.open(url,"_blank");
}

/* ===== Resumen (modal) ===== */
function openSummary(){
  const body=$("#summaryBody"); body.innerHTML="";
  cart.forEach(i=>{
    const div=document.createElement("div");
    div.innerHTML = `<strong>${i.name}</strong> <span class="muted">x${i.qty}</span>` + (i.details?`<div class="muted" style="font-size:12px">${i.details}</div>`:"");
    body.appendChild(div);
  });
  $("#sumTotalTxt").textContent = $("#totalTxt").textContent;
  const dlg=$("#summaryDlg"); dlg.showModal();
  $("#confirmSendBtn").onclick = async ()=>{ dlg.close(); await shareTicketOrFallback(); };
}

/* ===== FINALIZAR (paso 3) ===== */
function finalizar(){
  if(cart.length===0){ alert("Tu carrito está vacío."); return; }
  const ok = $('#inpNombre').value && $('#inpWhatsapp').value && $('#inpDireccion').value;
  if(!ok){ alert("Completá tus datos para continuar."); return; }
  openSummary();
}

/* ===== SHEETS ===== */
async function loadPricesFromSheet(){
  try{
    const rows = await fetch(PRICES_SHEET_URL + "?t=" + Date.now(), { cache:"no-store" }).then(r=>r.json());
    const map=new Map();
    rows.forEach(r=>{
      const id=String(r.id||"").trim();
      const price=Number(String(r.precio||0).replace(/\./g,"").replace(",", "."));
      if(id) map.set(id, isFinite(price)?price:0);
    });
    [...CATALOG.promos, ...CATALOG.pizzas, ...CATALOG.empanadasCombos].forEach(it=>{ if(map.has(it.id)) it.price=map.get(it.id); });
  }catch(e){ console.error("Sheet JSON error:", e); }
}

/* ===== Wizard ===== */
let STEP=1;
function updateSteps(){
  $$(".step").forEach(el=>{
    const n=Number(el.dataset.stepbtn);
    el.classList.toggle("active", n===STEP);
    el.classList.toggle("done", n<STEP);
  });
  $$("section[data-step]").forEach(sec=>{ sec.classList.toggle("hidden", Number(sec.dataset.step)!==STEP); });
  $("#prevBtn").disabled = STEP===1;
  $("#nextBtn").textContent = STEP<3 ? "Siguiente →" : "Finalizar pedido";
}
function nextStep(){
  if (STEP===1 && cart.length===0) { alert("Agregá al menos un producto al carrito."); return; }
  if (STEP===2){
    const ok = $('#inpNombre').value && $('#inpWhatsapp').value && $('#inpDireccion').value;
    if (!ok){ alert("Completá tus datos para continuar."); return; }
  }
  if (STEP<3){ STEP++; updateSteps(); window.scrollTo({top:0,behavior:'smooth'}); }
  else { finalizar(); }
}
function prevStep(){ if(STEP>1){ STEP--; updateSteps(); window.scrollTo({top:0,behavior:'smooth'});} }

/* ===== INIT ===== */
async function init(){
  await loadPricesFromSheet();
  wireStaticRows();
  refreshVisiblePrices();
  renderCart();

  loadCustomer();
  ['inpNombre','inpWhatsapp','inpDireccion','inpAclaracion'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    el.addEventListener('change',saveCustomer); el.addEventListener('blur',saveCustomer);
  });

  document.querySelectorAll('input[name="pay"]').forEach(r=> r.addEventListener('change', updatePayDetails));
  updatePayDetails();

  $("#prevBtn").onclick = prevStep;
  $("#nextBtn").onclick = nextStep;
  $("#finalBtn").onclick = finalizar;
  updateSteps();
}
init();
</script>
</body>
</html>

